# 手語識別排隊系統說明

## 🎯 系統概述

這是一個完整的排隊系統，用於管理多用戶手語影片識別請求，確保：
- **一次只處理一個影片**（避免資源衝突）
- **5秒語言選擇窗口**（支援多語言輸出）
- **智能排隊管理**（前3名暫存影片）
- **異步處理**（不阻塞其他請求）

---

## 📋 功能特性

### 1. **語言選擇機制**
用戶上傳影片後有 **5 秒窗口** 可以選擇輸出語言：

**支援語言：**
- 繁體中文（預設）
- 英文（English）
- 日文（日本語/日語）
- 韓文（한국어/韓文）
- 簡體中文
- 西班牙文
- 法文
- 德文

**使用方式：**
1. 用戶上傳影片
2. Bot 回覆：「請在 5 秒內回覆您想要的語言」
3. 用戶輸入：「英文」或「日文」等
4. 5 秒後自動確認（未回覆則預設繁體中文）

### 2. **排隊系統**
- ✅ **一次只處理一個影片**
- ✅ **自動排隊**：有影片處理中時新用戶自動排隊
- ✅ **排隊通知**：5 秒後告知用戶排在第幾位
- ✅ **前3名暫存**：加速處理速度
- ✅ **完成後自動處理下一個**

### 3. **防spam機制**
- ❌ 重複上傳影片 → 友善提示「請勿重複上傳」
- ❌ 無關文字訊息 → 提示「請傳送手語影片」
- ❌ 排隊中發送其他訊息 → 顯示當前狀態和排隊位置

### 4. **異步處理**
- 所有處理都在背景執行
- 不阻塞其他用戶請求
- 支援即時進度更新（WebSocket）

---

## 🔄 完整流程

```
用戶 A 上傳影片
    ↓
加入隊列（waiting_language 狀態）
    ↓
Bot：「請在5秒內選擇語言」
    ↓
─────────────────────────────────
│ 5秒內              │ 5秒後      │
│ 用戶輸入「英文」    │ 自動確認   │
│ → 設定語言         │ → 繁體中文 │
─────────────────────────────────
    ↓
檢查隊列
    ↓
─────────────────────────────────
│ 第1名              │ 第2-3名     │ 第4名以上   │
│ 立即處理           │ 暫存影片    │ 排隊等待   │
│ 狀態：processing   │ 顯示位置    │ 顯示位置   │
─────────────────────────────────
    ↓
處理影片（OpenAI 重組 + 語言翻譯）
    ↓
發送結果給用戶
    ↓
清理狀態 → 處理下一個
```

---

## 🎮 用戶體驗示例

### 情境 1：第一個用戶
```
用戶: [上傳影片]
Bot:  🎬 已收到您的手語影片！
      💬 請在 5 秒內回覆您想要的語言（例如：英文、日文、韓文）
      ⏱️ 如果沒有回覆，將預設使用繁體中文。

用戶: 英文
Bot:  ✅ 已設定輸出語言為：英文
      🎬 已收到您的手語影片！正在分析中，請稍候...

[處理中...]

Bot:  ✅ 識別完成！
      📝 結果：I want to learn sign language.
```

### 情境 2：排隊用戶
```
用戶 B: [上傳影片]
Bot:    🎬 已收到您的手語影片！
        💬 請在 5 秒內回覆您想要的語言...

用戶 B: 日文
Bot:    ✅ 已設定輸出語言為：日文

[5秒後]
Bot:    📋 您目前排在第 2 位，請稍候！
        （已選擇語言: 日文）

[輪到時]
Bot:    🎬 已收到您的手語影片！正在分析中，請稍候...
```

### 情境 3：spam 防護
```
用戶: [上傳影片]
Bot:  🎬 已收到您的手語影片！
      💬 請在 5 秒內回覆您想要的語言...

用戶: [再次上傳影片]
Bot:  ❌ 您已經在處理隊列中，請勿重複上傳！

用戶: 你好嗎？
Bot:  ✅ 您的影片正在排隊處理中（第 1 位）
      語言已設定為：繁體中文
      請耐心等候，我們會盡快完成！
```

---

## 🛠️ 技術實現

### 核心數據結構

```python
# 處理隊列（FIFO）
processing_queue = deque()  # [(sender_id, video_path, timestamp, language), ...]

# 當前處理中的用戶
current_processing = None

# 用戶狀態
user_states = {
    sender_id: {
        'status': 'waiting_language' | 'queued' | 'processing' | 'completed',
        'video_path': '/path/to/video.mp4',
        'language': '英文',
        'timestamp': datetime.now()
    }
}

# 語言選擇計時器
user_language_timers = {sender_id: Timer(...)}
```

### 關鍵函數

| 函數名 | 功能 |
|-------|------|
| `add_to_queue()` | 加入隊列 + 啟動5秒語言計時器 |
| `set_user_language()` | 設置用戶語言偏好 |
| `language_selection_timeout()` | 5秒超時處理 |
| `process_next_in_queue()` | 處理下一個任務 |
| `process_video_task()` | 異步處理影片（獨立線程） |
| `detect_language()` | 從文字檢測語言 |

---

## 📊 API 端點

### 1. 查詢排隊狀態
```bash
GET /queue_status
```

**回應：**
```json
{
  "queue_length": 3,
  "current_processing": "12345678...",
  "queue": [
    {
      "position": 1,
      "sender_id": "12345678...",
      "language": "英文",
      "timestamp": "2024-01-15T10:30:00",
      "status": "queued"
    }
  ]
}
```

### 2. 健康檢查（含排隊信息）
```bash
GET /health
```

**回應：**
```json
{
  "status": "healthy",
  "model_status": "ready",
  "queue_length": 2,
  "is_processing": true,
  "processed_count": 142
}
```

---

## 🔒 安全特性

1. **用戶隔離**：使用 sender_id 作為唯一標識
2. **防重複**：檢查用戶是否已在隊列中
3. **資源鎖**：使用 `threading.Lock()` 保護共享資源
4. **自動清理**：處理完成後延遲10秒清理狀態（防止立即重複）
5. **隱私保護**：API 只返回部分 sender_id（前8位）

---

## ⚡ 性能優化

1. **前3名暫存**：減少處理延遲
2. **異步處理**：所有任務在獨立線程中執行
3. **延遲初始化**：特徵提取器延遲載入
4. **進度回調**：即時更新處理進度（WebSocket）

---

## 🧪 測試建議

### 單用戶測試
1. 上傳影片 → 5秒內選擇語言 → 確認結果語言正確
2. 上傳影片 → 不選擇語言 → 確認預設繁體中文
3. 上傳影片 → 輸入無效語言 → 確認提示正確

### 多用戶測試
1. 用戶A上傳 → 用戶B立即上傳 → 確認B排隊
2. 用戶A處理中 → 用戶B發送文字 → 確認顯示排隊位置
3. 用戶A完成 → 確認自動處理用戶B

### Spam測試
1. 重複上傳影片 → 確認拒絕
2. 排隊中發送無關訊息 → 確認友善提示

---

## 📝 待優化項目

- [ ] 添加最大排隊時間限制（超時自動取消）
- [ ] 支援用戶主動取消排隊
- [ ] 添加排隊位置即時推送（當位置變動時通知用戶）
- [ ] 添加處理時間預估（根據歷史數據）
- [ ] 添加優先級機制（VIP用戶）

---

## 🎉 總結

這個排隊系統提供了：
✅ **無衝突處理**：一次只處理一個影片  
✅ **多語言支援**：8種語言輸出  
✅ **智能排隊**：自動管理處理順序  
✅ **友善體驗**：即時通知、防spam  
✅ **高性能**：異步處理、資源優化  

系統已經完全異步化，可以處理任意數量的並發請求！

